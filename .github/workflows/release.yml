name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Import Code Signing Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
          
          security import "$CERTIFICATE_PATH" \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain-db
          
          # Verify certificate is available
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"
          
      - name: Resolve Swift Package Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -scheme OpenCodeIsland \
            -project OpenCodeIsland.xcodeproj
            
      - name: Build and Sign App
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild archive \
            -scheme OpenCodeIsland \
            -configuration Release \
            -archivePath build/OpenCodeIsland.xcarchive \
            -destination "generic/platform=macOS" \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            OTHER_CODE_SIGN_FLAGS="--timestamp --options runtime"
            
      - name: Re-sign Sparkle Components with Hardened Runtime
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_PATH="build/OpenCodeIsland.xcarchive/Products/Applications/OpenCode Island.app"
          SIGN_ID="Developer ID Application"
          
          # Sign all Sparkle binaries with hardened runtime and timestamp
          echo "Signing Sparkle components..."
          
          # Sign Autoupdate
          codesign --force --timestamp --options runtime \
            --sign "$SIGN_ID" \
            "$APP_PATH/Contents/Frameworks/Sparkle.framework/Versions/B/Autoupdate"
          
          # Sign Updater binary
          codesign --force --timestamp --options runtime \
            --sign "$SIGN_ID" \
            "$APP_PATH/Contents/Frameworks/Sparkle.framework/Versions/B/Updater.app/Contents/MacOS/Updater"
          
          # Sign Downloader
          codesign --force --timestamp --options runtime \
            --sign "$SIGN_ID" \
            "$APP_PATH/Contents/Frameworks/Sparkle.framework/Versions/B/XPCServices/Downloader.xpc/Contents/MacOS/Downloader"
          
          # Sign Installer
          codesign --force --timestamp --options runtime \
            --sign "$SIGN_ID" \
            "$APP_PATH/Contents/Frameworks/Sparkle.framework/Versions/B/XPCServices/Installer.xpc/Contents/MacOS/Installer"
          
          # Sign XPC bundles
          codesign --force --timestamp --options runtime \
            --sign "$SIGN_ID" \
            "$APP_PATH/Contents/Frameworks/Sparkle.framework/Versions/B/XPCServices/Downloader.xpc"
          
          codesign --force --timestamp --options runtime \
            --sign "$SIGN_ID" \
            "$APP_PATH/Contents/Frameworks/Sparkle.framework/Versions/B/XPCServices/Installer.xpc"
          
          # Sign Updater.app bundle
          codesign --force --timestamp --options runtime \
            --sign "$SIGN_ID" \
            "$APP_PATH/Contents/Frameworks/Sparkle.framework/Versions/B/Updater.app"
          
          # Sign Sparkle framework
          codesign --force --timestamp --options runtime \
            --sign "$SIGN_ID" \
            "$APP_PATH/Contents/Frameworks/Sparkle.framework"
          
          # Re-sign main app
          codesign --force --timestamp --options runtime \
            --sign "$SIGN_ID" \
            "$APP_PATH"
          
          # Verify signature
          echo "Verifying signature..."
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"
          
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          
      - name: Install create-dmg
        run: brew install create-dmg
        
      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_PATH="build/OpenCodeIsland.xcarchive/Products/Applications/OpenCode Island.app"
          
          create-dmg \
            --volname "OpenCode Island" \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "OpenCode Island.app" 150 200 \
            --app-drop-link 450 200 \
            --hide-extension "OpenCode Island.app" \
            "OpenCodeIsland-${VERSION}.dmg" \
            "$APP_PATH" || true
            
          # Fallback to hdiutil if create-dmg fails
          if [ ! -f "OpenCodeIsland-${VERSION}.dmg" ]; then
            echo "create-dmg failed, using hdiutil..."
            hdiutil create -volname "OpenCode Island" \
              -srcfolder "$APP_PATH" \
              -ov -format UDZO \
              "OpenCodeIsland-${VERSION}.dmg"
          fi
          
          ls -la *.dmg
          
      - name: Sign DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          codesign --force --timestamp \
            --sign "Developer ID Application" \
            "OpenCodeIsland-${VERSION}.dmg"
            
      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "Submitting for notarization..."
          xcrun notarytool submit "OpenCodeIsland-${VERSION}.dmg" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait
          
          echo "Stapling notarization ticket..."
          xcrun stapler staple "OpenCodeIsland-${VERSION}.dmg"
          
          echo "Verifying notarization..."
          spctl -a -t open --context context:primary-signature -v "OpenCodeIsland-${VERSION}.dmg"
          
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenCodeIsland-${{ steps.version.outputs.version }}
          path: OpenCodeIsland-${{ steps.version.outputs.version }}.dmg
          
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: OpenCodeIsland-${{ steps.version.outputs.version }}.dmg
          name: OpenCode Island v${{ steps.version.outputs.version }}
          body: |
            ## OpenCode Island v${{ steps.version.outputs.version }}
            
            ### Installation
            1. Download `OpenCodeIsland-${{ steps.version.outputs.version }}.dmg`
            2. Open the DMG and drag OpenCode Island to Applications
            3. Launch OpenCode Island from Applications
            
            ### What's New
            - Signed and notarized by Apple for seamless installation
            - Auto-retry for background errors when summoning the island
            - Improved agent picker with dynamic sizing
            - Event stream reconnection with exponential backoff
            - Input auto-focus improvements
            
            ### Requirements
            - macOS 15.0+
            - [OpenCode CLI](https://opencode.ai) installed and configured
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
